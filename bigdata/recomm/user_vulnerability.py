import pandas as pd
import json

def user_vulnerability():
    ##################
    # 데이터 불러오기 #
    ##################

    # 문제목록 불러오기
    df = pd.read_csv('./data/df_problems_tags.csv', index_col=0)
    
    # 전체 태그목록 불러오기
    df_tags = pd.read_csv('./data/boj_taglist.csv', index_col=0)

    # 더미데이터 불러오기
    with open('./data/dummy/accountdata.json', 'r', encoding='utf-8') as f:
        json_data = json.load(f)
    dum_raw = json_data['solved']
    dum_raw = pd.DataFrame(dum_raw)


    dum = pd.merge(dum_raw, df, how='left', left_on='id', right_on='problemId')

    # 푼 문제 목록 추출
    solved_list = dum.loc[dum['status']=='solved'].sort_values('id')
    # 태그별로 문제 적게 푼 순으로 태그 나열
    solved_list = solved_list.groupby('bojTagId').count().sort_values('problemId', ascending=True).reset_index()['bojTagId']
    # list 형태로 변형
    solved_list = list(solved_list)

    # 푼 문제 평균 레벨 추출
    solved_cnts = []

    for solved_tag in solved_list:
        cond1 = (dum['status']=='solved')
        cond2 = (dum['bojTagId']==solved_tag)
        cond_list = list(dum.loc[cond1&cond2]['problemId'])
        solved_cnts.append(len(cond_list))
        print(f'{solved_tag}번 태그 문제를 {len(cond_list)}개 풀었습니다.')
        print(f'문제목록:\n{cond_list}\n')

    print(f'푼 문제 태그 목록:\n{solved_list}\n')
    print(f'푼 문제 수:\n{solved_cnts}')

    # 몇번 태그 몇문제 풀었는지 df 생성
    df_vul = pd.DataFrame({
        'bojTagId': solved_list,
        'solvedcnt': solved_cnts
    })
    # 문제 적게 푼 순으로 10개 추출 후 데이터 병합
    df_vul = df_vul[:10]
    df_vul = pd.merge(df_vul, df_tags)

    # json 형태로
    vul_json = df_vul.to_json(orient='records')
    vul_list = json.dumps(json.loads(vul_json), indent="\t", ensure_ascii=False)
    return vul_list